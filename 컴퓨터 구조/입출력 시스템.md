# 입출력 시스템
입출력 작업을 수행하려면 CPU와 장치 컨트롤러가 정보를 주고받아야 한다.
CPU와 장치 컨트롤러가 정보를 주고 받는 방법은 크게 3가지가 있다.

1. 프로그램 입출력
2. 인터럽트 기반 입출력
3. DMA 입출력

## 1. 프로그램 입출력
> 프로그램 입출력은 기본적으로 프로그램 속 명령어로 입출력장치를 제어하는 방법

CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하며 입출력 작업을 수행

메모리에 저장된 정보를 하드 디스크에 백업하는 상황이라면 CPU는 대략 아래 과정으로 입출력 작업을 한다.

1) CPU가 하드 디스크 장치 컨트롤러(의 제어 레지스터)에 쓰기 명령을 보낸다.
![프로그램입출력(1).png](./images/입출력 시스템/프로그램입출력(1).png)
2) 장치 컨트롤러는 하드 디스크의 상태를 확인하여 상태 레지스터에 준비된 상태임을 표시한다.
![프로그램입출력(2).png](./images/입출력 시스템/프로그램입출력(2).png)
3) CPU가 주기적으로 상태 레지스터를 확인하다가 장치가 준비된 상태가 되면, 저장할 데이터를 데이터 레지스터에 쓴다.
![프로그램입출력(3).png](./images/입출력 시스템/프로그램입출력(3).png)

CPU는 여러 장치 컨트롤러의 레지스터들을 모두 알고 있는 것은 매우 힘들다.
따라서 입출력 명령어 표현과 메모리에 저장은 아래와 같이 크게 두 가지 방식이 있다.

### 1) 메모리 맵 입출력
> 메모리에 접근하기 위한 주소 공간과 입출력 장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법

**장점**

메모리와 입출력장치가 같은 주소 공간을 사용하기 때문에 같은 명령어를 사용한다.(입출력 전용 명령어가 필요하지 않음)

**단점**

하나의 주소 공간에 같이 사용하기 때문에 메모리 주소 공간이 축소된다.

### 2) 고립형 입출력
> 메모리를 위한 주소 공간과 입출력 장치를 위한 주소 공간을 분리하는 방법

**장점**

주소 공간이 서로 분리되어 있기 때문에 메모리 주소 공간이 축소되지 않는다.

**단점**

분리된 주소 공간으로 인해 입출력 전용 명령어를 사용하여 장치 컨트롤러에 접근해야 한다.

## 2. 인터럽트 기반 입출력
> 장치 컨트롤러가 하드웨어 인터럽트를 발생시켜 CPU에게 입출력이 완료되었음을 알리는 방법

입출력 장치가 CPU가 요청한 작업을 완료하고 나면 장치 컨트롤러가 작업은 완료했다는 인터럽트를 발생시킨다. 

프로그램 입출력에서 하드 디스크에 데이터를 백업할 때처럼 CPU가 주기적으로 상태 레지스터를 확인하지 않고 요청이 오면 확인하면 되기 때문에 CPU가 좀 더 효율적으로 일할 수 있다.

![인터럽트 기반 입출력(1).png](./images/입출력 시스템/인터럽트 기반 입출력(1).png)
### 2-1) 인터럽트가 발생한 순서대로 처리
다른 입출력장치에 의한 하드웨어 인터럽트를 받아들이지 않기 때문에 CPU는 순차적으로 하드웨어 인터럽트를 처리
![인터럽트 기반 입출력(2).png](./images/입출력 시스템/인터럽트 기반 입출력(2).png)
### 2-3) 인터럽트 우선순위에 따라 처리
이 경우는 인터럽트 비트를 비활성화해도 무시할 수 없는 인터럽트인 NMI(Non-Maskable Interrupt)가 발생한 경우 CPU는 우선순위가 높은 인터럽트부터 처리한다.
![인터럽트 기반 입출력(3).png](./images/입출력 시스템/인터럽트 기반 입출력(3).png)



## 3. DMA(Direct Memory Access)
> CPU의 개입 없이 장치 컨트롤러가 메모리에 직접 데이터를 읽고 쓰는 방법
 
프로그램 기반 입출력과 인터럽트 기반 입출력의 공통점은 아래와 같다.

입출력장치와 메모리 간의 데이터 이동은 CPU가 주도한다. 이동하는 데이터도 반드시 CPU를 거친다

그래서 입출력장치와 메모리가 CPU를 거치지 않고도 상호작용할 수 있는 입출력 방식인 DMA(Direct MEmory Access)가 등장하였다.

![DMA(1)](./images/입출력 시스템/DMA(1).png)

### DMA의 입출력 과정

일반적으로 DMA 입출력은 아래와 같이 이뤄진다.

1. CPU는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산(읽기/쓰기), 읽거나 쓸 메모리의 주소등과 같은 정보로 입출력 작업을 명령
2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행. 이때 DMA 컨트롤러는 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 쓴다.
3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알린다.

![DMA(2)](./images/입출력 시스템/DMA(2).png)
![DMA(3)](./images/입출력 시스템/DMA(3).png)
![DMA(4)](./images/입출력 시스템/DMA(4).png)

CPU는 DMA 컨트롤러에게 입출력 작업 명령을 내리고, 인터럽트만 받으면 되기 때문에 작업 부담을 훨씬 줄일 수 있다.

즉, CPU는 오로지 입출력의 시작과 끝에만 관여하면 된다.

하지만 DMA 컨트롤러는 시스템 버스로 메모리에 직접 접근하는데, 시스템 버스는 동시 사용이 불가하다.

시스템 버스는 공용자원이기 때문이다.

따라서 CPU가 시스템 버스를 사용할 때 DMA 컨트롤러는 시스템 버스를 사용할 수 없고, DMA 컨트롤러가 시스템 버스를 사용할 때는 CPU가 시스템 버스를 사용할 수 없다.

그래서 아래의 두 가지 방법을 사용한다.

- DMA컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 시스템 버스를 조금씩 사용
- DMA컨트롤러는 CPU가 일시적으로 시스템 버스를 이용하지 않도록 허락을 구하고 시스템 버스를 집중적으로 사용

위와 같은 DMA의 시스템 버스 이용을 사이클 스틸링이라고 부른다.


## 입출력 버스
> 입출력 버스는 CPU와 입출력 장치 사이의 데이터 전송을 담당하는 버스이다.

CPU, 메모리, DMA 컨트롤러, 장치 컨트롤러가 모두 같은 버스를 공유하는 구성에서는 DMA를 위해 한 번 메모리에 접근할 때마다 시스템 버스를 두 번 사용하게 되는 부작용이 있다.

DMA 입출력 과정을 다시 생각해 보면

1. 메모리에서 DMA 컨트롤러로 데이터를 가져오기 위해 시스템 버스를 한 번 사용하고
2. DMA 컨트롤러의 데이터를 장치 컨트롤러로 옮기기 위해 시스템 버스를 또 한 번 사용한다.

![입출력 버스(1)](./images/입출력 시스템/입출력 버스(1).png)
DMA를 위해 시스템 버스를 너무 자주 사용하면 그만큼 CPU가 시스템 버스를 이용하지 못한다.
이 문제는 DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스라는 별도의 버스에 연결하여 해결할 수 있다.

![입출력 버스(2)](./images/입출력 시스템/입출력 버스(2).png)

위 그림과 같이 장치 컨트롤러들이 시스템 버스가 아닌 입출력 버스로 DMA 컨트롤러에 연결된다면 DMA 컨트롤러와 장치 컨트롤러가 서로 데이터를 전송할 때는 시스템 버스를 이용할 필요가 없으므로 시스템 버스의 사용 빈드롤 줄일 수 있다.

현대 컴퓨터에는 입출력 버스가 있다.

즉, 대부분의 입출력장치(장치 컨트롤러)는 시스템 버스가 아닌 입출력 버스와 연결된다.

---
# 질문
1. 프로그램 입출력과 인터럽트 기반 입출력의 차이점은 무엇인가요?
2. DMA 입출력은 어떤 방식으로 동작하나요?
3. 입출력 버스의 역할은 무엇인가요?

<br>

---

#### 참고
- [[컴퓨터 구조] 입출력 방법(프로그램 입출력, 인터럽트 기반 입출력, DMA 입출력)](https://rebugs.tistory.com/306)
- [[컴퓨터 구조] - 입출력 장치 (I/O Device)](https://kangdy25.tistory.com/111#%EC%9E%85%EB%A0%A5%20%EC%9E%A5%EC%B9%98-1)
- [[컴퓨터 공학 기초 강의] 21강. 다양한 입출력 방법](https://www.youtube.com/watch?v=RRgGVu8OCP4&list=PLVsNizTWUw7FCS83JhC1vflK8OcLRG0Hl&index=23)