# 중앙처리장치(CPU) 작동 원리

## 중앙처리장치(CPU)란?

중앙처리장치(CPU)는 명령어의 해석과 자료의 연산, 비교등의 처리를 제어하는 컴퓨터 시스템의 핵심장치이다.

다양한 입력 장치로부터 정보를 입력받아 처리한 후, 그 결과를 출력장치로 보내는 일련의 과정을 제어하고 조정하는 일을 수행한다.

CPU는 사람의 두뇌와 같이 컴퓨터의 모든 시스템을 제어, 처리하는 가장 핵심적인 장치라고 할 수 있다.

## CPU의 구성 요소

![CPU의 구성요소](<images/중앙처리장치(CPU)%20작동%20원리/CPU의%20구성요소.png>)
CPU의 주요 구성 요소로는 산술 및 논리 연산을 수행하는 ALU(Arithmetic Logic), 명령어의 순서와 수행을 제어하는 제어 유닛(Control Unit), 그리고 중간 결과와 작업 상태를 저장하는 레지스터(Register)가 있다. 그리고 각 구성요소는 CPU 내부 버스로 연결 되어 있다.

### 연산 장치 (ALU: Arithmetic and Logical Unit)

산술연산과 논리연산을 수행한다. (따라서 산술논리 연산장치라고도 불린다.)  
연산에 필요한 데이터를 레지스터에서 가져오고, 연산 결과를 다시 레지스터로 보낸다.

산술 연산은 덧셈, 뺄셈, 곱셈, 나눗셈 등을 포함하며, 논리 연산은 AND, OR, NOT 등의 비트 수준 연산을 포함한다.

또한 비트 이동, 조건 검사와 같은 역할도 수행한다.

![ALU 구조](<images/중앙처리장치(CPU)%20작동%20원리/ALU%20구조.png>)

> **💡 ALU의 기능을 우리 뇌와 연관지어 연습장에 적힌 1+2를 연산하는 과정을 보자.** </br>  
> 우리도 연산을 하기 위해서는 지시를 하는 뇌(CU)에서 어떤 연산을 하라는 지시(control signal)가 있어야 하고, 연산을 하는 뇌(ALU)에서는 연습장(resgister)에 적힌 1과 2(data)를 연산하고, 끝냈을 때 나오는 결과(result)를 다시 연습장(resigster)에 적는다.
> 조금 다른점은 컴퓨터는 0과1로 만들어진 데이터를 읽기 때문에 음수부호(-)를 표현하지 못한다. 이러한 연산결과에 대한 부가 정보를 깃발(flag)라는 이름을 가진 데이터 덩어리로 구분짓는다.

#### flag의 종류

| 종류              | 의미                                                        |
| ----------------- | ----------------------------------------------------------- |
| 부호 플래그       | 연산한 결과의 부호를 나타냄                                 |
| 제로 플래그       | 연산 결과가 0인지 여부를 나타냄                             |
| 캐리 플래그       | 연산 결과 올림수나 빌림수가 발생했는지를 나타냄             |
| 오버플로우 플래그 | 오버플로우가 발생했는지를 나타냄                            |
| 인터럽트 플래그   | 인터럽트가 가능한지를 나타냄                                |
| 슈퍼바이저 플래그 | 커널 모드로 실행 중인지, 사용자 모드로 실행 중인지를 나타냄 |

- 오버플로우 : 계산결과가 레지스터의 용량보다 커질경우
- 인터럽트 : 프로그램 실행 중 CPU의 현재 처리 순서를 중단하고 다른 동작을 수행하도록 요구하는 동작
- 커널모드 : 커널 모드는 운영체제의 핵심 기능을 수행할 수 있는 모드. 시스템 자원에 대한 무제한 접근 권한을 가지며, 다양한 프로세스들을 관리하고 하드웨어 리소스를 제어할 수 있음
- 사용자모드 : 사용자 모드는 일반 응용 프로그램이 동작하는 모드로, 제한된 시스템 자원 접근 권한을 가지는 모드

#### ALU의 구성 요소

ALU의 구성은 설계된 ALU의 아키텍처나 구현 방식에 따라서 내부구성이 달라진다.

- 입력 레지스터: 연산에 사용할 데이터를 저장하는 레지스터
- 연산기(Adder, Subtractor 등): 산술 연산을 수행하는 회로
- 논리 회로: 논리 연산을 수행하는 회로
- 누산기(Accumulator): 연산 결과를 일시적으로 저장하는 레지스터
- 연산 결과에 따른 상태(예: 오버플로, 제로, 부호)를 표시하는 플래그

### 제어 장치 (CU: Control Unit)

CU는 레지스터 사이의 데이터 전송을 감시하고 ALU의 동작을 지시하는 장치이다.
전체 컴퓨터 시스템의 작동을 통제 지시하는 장치로, 적정한 순서로 명령을 꺼내고, 각 명령을 해석하여 그 해석에 따라서 ALU나 메모리 등에 필요한 신호를 보낸다.

![제어장치 구조](<images/중앙처리장치(CPU)%20작동%20원리/제어장치%20구조.png>)

CU는 컴퓨터의 클럭 신호를 받아 타이밍을 맞추고 다른 부품들과 동기화를 유지하며, 명령어 레지스터에서 받은 명령어와 플래그 레지스터에서 받은 플래그를 해석해 필요한 제어 신호를 생성한다. 이 신호는 CPU 내부와 외부의 하드웨어 구성 요소들에 전달되어, 메모리와 입출력 장치 간의 데이터 교환을 관리하고, ALU나 레지스터 등의 내부 연산을 제어한다. 이를 통해 제어장치는 CPU의 작동을 조율하고, 시스템의 전체적인 동작을 관리한다.

### 레지스터 (Register)

CPU에서는 주기억장치로부터 읽어 온 명령어와 데이터를 임시적으로 보관할 수 있는 장치가 필요하며, ALU에서 처리된 결과 데이터를 임시로 보관할 수 있는 장치이다.

저장공간들 (SSD, HDD, SRAM, DRAM 등등 ) 중 가장 빠른 속도를 가지며 DRAM과 같이 휘발성 저장 장치이다.

용도에 따라 범용 레지스터와 특수 목적 레지스터로 나뉘어 진다
![레지스터 구조](<images/중앙처리장치(CPU)%20작동%20원리/레지스터%20구조.png>)

CPU의 구조를 약식화한 그림이며, Program Counter, Memeory Address, Memory Buffer, Command 네가지 레지스터가 나타나 있다. 이 외에도 2가지 종류의 레지스터에 대해 알아보도록 하자.

#### 레지스터의 종류

- **범용 레지스터 (General Purpose Register)**

  - 다양한 연산이나 데이터 저장 등 여러 목적으로 사용할 수 있는 레지스터.
  - 프로그램 실행 중 필요한 데이터를 임시로 저장하거나 연산에 사용됩니다.

- **특수목적 레지스터**

  - 특정한 기능을 수행하기 위해 특별히 설계된 레지스터.

  1. **주소를 기억하는 레지스터**

     - **MAR (메모리 주소 레지스터)**: 읽기와 쓰기 연산을 수행할 주기억장치 주소를 저장한다.
     - **PC (프로그램 카운터)**: 다음에 실행될 명령어의 주소를 저장하며, 프로그램 실행 순서를 관리한다.
     - **SP (스택 포인터)**: 스택의 최상위 주소를 저장하며, 함수 호출과 복귀 시 스택을 관리한다.

  2. **데이터를 기억하는 레지스터**
     - **IR (명령어 레지스터)**: 현재 실행 중인 명령어를 임시로 저장하여 해독하기 위해 사용된다.
     - **MBR (메모리 버퍼 레지스터)**: 주기억장치에서 읽어온 데이터를 임시로 저장하거나, 데이터를 주기억장치에 쓰기 전에 임시로 저장한다.
     - **AC (누산기)**: 산술 논리 장치(ALU)의 연산 결과를 임시로 저장하는 역할을 하며, 연산의 중간 결과를 저장해 다음 연산에 사용된다.
     - **플래그 레지스터 (Flag Register)**: 연산의 결과나 CPU의 상태 정보를 저장하며, 이 정보를 바탕으로 다음 연산이나 분기 결정이 이루어진다.

## CPU의 동작 과정

![CPU의 동작 과정](<images/중앙처리장치(CPU)%20작동%20원리/CPU%20동작%20과정.png>)

1. 주기억장치는 입력장치에서 입력받은 데이터 또는 보조기억장치에 저장된 프로그램 읽어옴
2. CPU는 프로그램을 실행하기 위해 주기억장치에 저장된 프로그램 명령어와 데이터를 읽어와 처리하고 결과를 다시 주기억장치에 저장
3. 주기억장치는 처리 결과를 보조기억장치에 저장하거나 출력장치로 보냄
4. 제어장치는 1~3 과정에서 명령어가 순서대로 실행되도록 각 장치를 제어

### CPU의 동작 과정 중 구성 요소들이 하는 역할

제어장치(CU): 주기억장치에서 명령어를 읽어와 해석하고, ALU와 레지스터 등 CPU의 다른 구성 요소들을 제어합니다. CU는 명령어가 순서대로 실행되도록 각 장치를 조율한다.

산술 논리 장치(ALU): 명령어 실행 중 산술 연산이나 논리 연산이 필요할 때, CU의 제어 하에 ALU가 이 작업을 수행한다. 예를 들어, 덧셈, 뺄셈, 비교 연산 등이 포함된다.

레지스터: 명령어 실행 과정에서 데이터를 임시로 저장하는 고속 메모리로, 주기억장치에서 읽어온 데이터나 ALU의 연산 결과를 일시적으로 보관하는 역할을 한다. CPU의 각 구성 요소 간에 데이터가 오갈 때 레지스터가 중요한 매개체가 된다.

## 명령어 세트

데이터나 데이터의 저장 위치를 나타내는 피 연산자(Operand)로 구성된다.

연산코드는 연산, 제어, 데이터 전달, 입출력기능을 가진다.

피연산자는 주소, 숫자, 문자, 논리데이터를 저장한다.

CPU가 주기억장치에서 한번에 하나의 명령어를 인출하여 실행하는데, 이러한 일련의 활동을 '명령어 사이클' 이라고 한다.

## 명령어 사이클

CPU에서는 프로그램을 실행하기 위해 주기억장치에서 명령어를 순차적으로 인출하여 해독하고 실행하는 과정을 반복하는데, CPU가 주기억장치에서 한 번에 하나의 명령어를 인출하여 실행하는데 필요한 일련의 활동을 명령어 사이클 (Instruction Cycle)이라고 한다.

명령어 사이클은 인출 사이클, 실행 사이클, 간접 사이클, 인터럽트 사이클로 세분화 시킬 수 있는데, 인출 사이클과 실행 사이클은 항상 수행되지만 / 간접 사이클과 인터럽트 사이클은 주소 지정방식이 필요할 때나 인터럽트 요구가 있을 때만 수행된다.

### 간접 사이클과 인터럽트 사이클에 의한 명령어 처리과정

#### 간접 사이클

간접 사이클은 CPU가 명령어 실행 과정에서 간접 주소 지정 방식을 사용할 때, 실제 데이터를 얻기 위해 수행되는 추가적인 메모리 접근 과정이다. 이 과정은 명령어에 지정된 주소가 실제 데이터가 있는 주소가 아니라, 데이터의 주소를 가리키는 경우에 발생한다.

```
T0: MAR ← (IR[Address])
(명령어 레지스터(IR)의 주소 필드에서 값을 읽어 메모리 주소 레지스터(MAR)에 저장하여 메모리 접근 준비)

T1: MBR ← M[MAR]
(MAR이 가리키는 메모리 위치에서 실제 데이터를 가리키는 주소를 메모리 버퍼 레지스터(MBR)에 저장)

T2: IR[Address] ← MBR
(MBR에 있는 데이터를 명령어 레지스터(IR)의 주소 필드에 저장하여 실제 데이터의 주소를 명령어에 반영)
```

간접 사이클은 간접 주소 지정 방식으로 인해 추가적인 메모리 접근이 필요할 때 발생한다. CPU는 먼저 명령어 레지스터(IR)에 있는 주소 필드 값을 사용하여 메모리에서 데이터의 주소를 찾는다. 그 후, 이 주소를 명령어 레지스터에 반영하여 실제 데이터가 위치한 주소로 업데이트한다. 이 과정을 통해 CPU는 최종적으로 데이터에 접근할 수 있게 된다.

### 인터럽트 사이클

인터럽트 사이클은 CPU가 현재 작업을 중단하고, 인터럽트 요청을 처리하기 위해 필요한 과정이다.

```
T0: MBR ← PC
(현재 프로그램 카운터(PC)의 값을 메모리 버퍼 레지스터(MBR)에 저장하여 현재 위치를 기록)

T1: MAR ← Interrupt Vector
(인터럽트 벡터 주소를 메모리 주소 레지스터(MAR)로 전달하여 인터럽트 처리 루틴의 주소를 가져올 준비)

T2: M[MAR] ← MBR
(인터럽트 벡터 주소에서 현재 PC 값을 읽어 메모리의 지정된 위치에 저장하여 복귀 시 사용할 수 있도록 준비)

T3: PC ← Interrupt Routine Address
(프로그램 카운터(PC)를 인터럽트 처리 루틴의 시작 주소로 설정하여 인터럽트를 처리)
```

인터럽트 사이클에서는 현재 명령어의 주소를 저장하고, 인터럽트 루틴의 주소를 설정하여 CPU가 인터럽트 요청을 처리할 수 있도록 한다. 처리 후에는 원래의 프로그램으로 복귀할 수 있다.

# 참고 자료

- [중앙처리장치(CPU) 작동 원리 - Velog](https://velog.io/@meongkune/%EC%A4%91%EC%95%99%EC%B2%98%EB%A6%AC%EC%9E%A5%EC%B9%98CPU-%EC%9E%91%EB%8F%99-%EC%9B%90%EB%A6%AC)
- [[컴퓨터구조] CPU의 작동 원리 (1)- Tistory](https://maloveforme.tistory.com/152)
